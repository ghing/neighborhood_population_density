{% extends "base.html" %}

{% block headstyles %}
<link href="{{ STATIC_URL }}css/demo_table.css" rel="stylesheet">
<link href="{{ STATIC_URL }}css/demo_table_jui.css" rel="stylesheet">
{% endblock %}

{% block headscripts %}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/openlayers/OpenLayers.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/utils.js"></script>
<script type="text/javascript">
var MAX_POPULATION_DENSITY = {{ city.max_population_density }};
var MIN_POPULATION_DENSITY = {{ city.min_population_density }};

function populationDensityStyle() {
    var style = new OpenLayers.Style();
    var rules = Array();
    var minOpacity = 0.3;
    var maxOpacity = 1;
    var numSegments = 5;
    var opacityIncrement = (maxOpacity - minOpacity) / numSegments;
    var opacity = minOpacity;

    $.each(makeSegments(MIN_POPULATION_DENSITY, MAX_POPULATION_DENSITY, numSegments), function(index, segment) {
        console.debug(segment[0]);
        var rule = new OpenLayers.Rule({
            filter: new OpenLayers.Filter.Comparison({
                type: OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,
                property: "population_density",
                value: segment[0] 
            }),
            symbolizer: {fillColor: "green", fillOpacity: opacity, strokeColor: "black"}
        });
        rules.push(rule);
        opacity += opacityIncrement;
    });

    style.addRules(rules);
    return style;
}

$(document).ready(function() {
	$('.datatable').dataTable({
		"bJQueryUI": true
    });

    var map = new OpenLayers.Map('city-map-chicago', {
      projection: new OpenLayers.Projection("EPSG:900913")
    });
    map.addLayer(new OpenLayers.Layer.OSM());
    map.setCenter(new OpenLayers.LonLat(-87.65, 41.85) // Center of the map
          .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            new OpenLayers.Projection("EPSG:900913") // to Spherical Mercator Projection
          ), 2 // Zoom level
        );
    var styleMap = new OpenLayers.StyleMap(populationDensityStyle());
    var geojson = new OpenLayers.Layer.GML("GeoJSON", "neighborhoods.json", {
        projection: new OpenLayers.Projection("EPSG:4326"),
        format: OpenLayers.Format.GeoJSON,
        styleMap: styleMap
    });    
    geojson.events.on({
        "loadend": function() {
            map.zoomToExtent(geojson.getDataExtent());
        }
    });
    map.addLayer(geojson); 
} );
</script>
{% endblock %}

{% block content %}
<h1>Comparing Population Densities</h1>

<h2>{{ city.name }}</h2>

<div id="city-map-{{ city.name|lower }}" class="city-map" style="width:100%; height:100%"></div>
<table class="datatable">
    <thead>
        <tr>
            <th>Neighborhood</th>
            <th>Population Density</th>
            <th>Total Population</th>
        </tr>
    <thead>
    <tfoot>
        <tr>
            <td>Median Population Density</td>
            <td colspan="2">{{ city.median_population_density }}</td>
        </tr>
    <tbody>
    {% for n in city.neighborhoods %}
        <tr>
            <td>{{ n.name }}</td>
            <td>{{ n.population_density }}</td>
            <td>{{ n.total_population }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>
{% endblock %}
